import cv2
import mediapipe as mp
import numpy as np

# הגדרות MediaPipe ו-OpenCV
mp_face_mesh = mp.solutions.face_mesh
face_mesh = mp_face_mesh.FaceMesh(refine_landmarks=True)
mp_drawing = mp.solutions.drawing_utils

# מודל 3D
model_points = np.array([
    (0.0, 0.0, 0.0),             # אף
    (0.0, -330.0, -65.0),         # סנטר
    (-225.0, 170.0, -135.0),      # עין שמאל
    (225.0, 170.0, -135.0),       # עין ימין
    (-150.0, -150.0, -125.0),     # פה שמאל
    (150.0, -150.0, -125.0)       # פה ימין
])

# הגדרת מצלמה
cap = cv2.VideoCapture(0)

while cap.isOpened():
    ret, frame = cap.read()
    if not ret:
        break

    frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
    results = face_mesh.process(frame_rgb)

    if results.multi_face_landmarks:
        for face_landmarks in results.multi_face_landmarks:
            img_points = np.array([
                (face_landmarks.landmark[1].x, face_landmarks.landmark[1].y),  # אף
                (face_landmarks.landmark[152].x, face_landmarks.landmark[152].y),  # סנטר
                (face_landmarks.landmark[33].x, face_landmarks.landmark[33].y),  # עין שמאל
                (face_landmarks.landmark[263].x, face_landmarks.landmark[263].y),  # עין ימין
                (face_landmarks.landmark[61].x, face_landmarks.landmark[61].y),  # פה שמאל
                (face_landmarks.landmark[291].x, face_landmarks.landmark[291].y)   # פה ימין
            ], dtype="double")

            # שימוש ב-solvePnP
            focal_length = frame.shape[1]
            center = (frame.shape[1] / 2, frame.shape[0] / 2)
            camera_matrix = np.array([
                [focal_length, 0, center[0]],
                [0, focal_length, center[1]],
                [0, 0, 1]
            ], dtype="double")

            dist_coeffs = np.zeros((4, 1))  # הנחת עדשה ללא עיוות
            success, rotation_vector, translation_vector = cv2.solvePnP(
                model_points, img_points, camera_matrix, dist_coeffs)

            # הקרנת נקודות המבט לתלת-ממד
            (nose_end_point2D, jacobian) = cv2.projectPoints(
                np.array([(0.0, 0.0, 1000.0)]), rotation_vector, translation_vector, camera_matrix, dist_coeffs)

            # ציור כיוון המבט
            p1 = (int(img_points[0][0]), int(img_points[0][1]))
            p2 = (int(nose_end_point2D[0][0][0]), int(nose_end_point2D[0][0][1]))
            cv2.line(frame, p1, p2, (0, 255, 255), 2)

    cv2.imshow('Eye Gaze Estimation', frame)

    if cv2.waitKey(5) & 0xFF == 27:
        break

cap.release()
cv2.destroyAllWindows()