<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaze-based Selection</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }

        .focusButton {
            width: 300px;
            height: 150px;
            background-color: #4CAF50;
            color: white;
            font-size: 30px;
            border: none;
            margin: 50px;
            text-align: center;
            line-height: 150px;
            border-radius: 15px;
            display: none;
        }

        #noButton {
            background-color: #F44336;
        }

        #gazeDot {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: blue;
            border-radius: 50%;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Gaze-based Selection</h1>
    <p>Click the button to start calibration:</p>
    <button id="startButton" onclick="initializeSystem()">Start Calibration</button>

    <div id="yesButton" class="focusButton" onclick="speak('Yes')">Yes</div>
    <div id="noButton" class="focusButton" onclick="speak('No')" style="background-color: #F44336;">No</div>
    
    <div id="gazeDot"></div>

    <script>
        let initialized = false;

        // Function to trigger voice output
        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US';  // Set language to English (US)
            window.speechSynthesis.speak(msg);
        }

        // Initialize system and check camera access
        function initializeSystem() {
            if (!initialized) {
                console.log("Initializing system...");

                // בדוק אם WebGazer נטען
                if (typeof webgazer === "undefined") {
                    alert("WebGazer failed to load. Please check the script source.");
                    return;
                }

                try {
                    webgazer.setRegression('ridge')
                            .setTracker('clmtrackr')
                            .begin()
                            .showPredictionPoints(true); // Show gaze prediction points for debugging
                            
                    console.log("WebGazer started.");

                    // Check if camera access works
                    requestCameraAccess(); // Request camera permissions
                    initialized = true;
                    document.getElementById('startButton').style.display = 'none';
                    startCalibration(); // Start calibration process
                } catch (error) {
                    console.error("Error initializing WebGazer:", error);
                    alert("Failed to initialize WebGazer. Please check camera permissions.");
                }
            }
        }

        // Request camera access
        function requestCameraAccess() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    console.log("Camera access granted.");
                })
                .catch(function(err) {
                    console.error("Camera access denied:", err);
                    alert("Camera access is required for gaze tracking.");
                });
        }

        // Start simple calibration
        function startCalibration() {
            console.log("Calibration started.");
            document.getElementById('yesButton').style.display = 'inline-block';
            document.getElementById('noButton').style.display = 'inline-block';
            document.getElementById('gazeDot').style.display = 'block';
            startTracking(); // Begin gaze tracking
        }

        // Start tracking gaze
        function startTracking() {
            webgazer.setGazeListener((data, elapsedTime) => {
                if (data == null) return;
                console.log(`Gaze Data: X=${data.x}, Y=${data.y}`);
                const gazeDot = document.getElementById('gazeDot');
                gazeDot.style.left = `${data.x - 7}px`;  // Center the dot
                gazeDot.style.top = `${data.y - 7}px`;
            }).begin();
        }
    </script>
</body>
</html>
